<!DOCTYPE html>
<html lang="en">

  <head>

    <script src="https://use.fontawesome.com/afd448ce82.js"></script>
    
    <!-- Meta Tag -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <!-- SEO -->
    <meta name="author" content="Bruno Rocha">
    <meta name="keywords" content="Software, Hardware, Tech, Articles, Tutorials, Apple">
    <meta name="description" content="Have you ever had issues with Xcode not symbolicating crashes? Me too, and I found the fix by reverse engineering the IDE.">
    <meta name="title" content="Reverse engineering a 5 year old Xcode issue">
    <meta name="url" content="https://rockbruno.com/reverse-engineering-xcode-issue-crash-symbol">
    <meta name="image" content="https://rockbruno.com/images/thumbs/basethumb.png">
    <meta name="copyright" content="Bruno Rocha">
    <meta name="robots" content="index,follow">

    <meta property="og:title" content="Reverse engineering a 5 year old Xcode issue"/>
    <meta property="og:image" content="https://rockbruno.com/images/thumbs/basethumb.png"/>
    <meta property="og:description" content="Have you ever had issues with Xcode not symbolicating crashes? Me too, and I found the fix by reverse engineering the IDE."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://rockbruno.com/reverse-engineering-xcode-issue-crash-symbol"/>

    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://rockbruno.com/images/thumbs/basethumb.png"/>
    <meta name="twitter:image:alt" content="Page Thumbnail"/>
    <meta name="twitter:title" content="Reverse engineering a 5 year old Xcode issue"/>
    <meta name="twitter:description" content="Have you ever had issues with Xcode not symbolicating crashes? Me too, and I found the fix by reverse engineering the IDE."/>
    <meta name="twitter:site" content="@rockbruno_"/>
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="images/favicon/favicon-4.ico">
    <link rel="mask-icon" href="images/favicon/favicon-4.ico">
    <link rel="apple-touch-icon" href="images/favicon/apple-touch-icon.png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:light,lightitalic,regular,regularitalic,medium,mediumitalic,bold,bolditalic,black,blackitalic">
    
    

  <!-- Prism CSS Stylesheet --> 
  <link rel="stylesheet" type="text/css" href="css/prism3.css"> 
  <!-- Main CSS Stylesheet --> 
  <link rel="stylesheet" type="text/css" href="css/style48.css">

  </head>

 <body>
      
    
    
     
    
    
  <div class="main">
    <div class="header padded">
      <h1>Bruno Rocha</h1>
      <p class="header-text">on Software Engineering & Electronics</p>
      <div class="header-sections">
        <a href="https://rockbruno.com">BLOG</a>
        <text>/</text>
        <a href="projects">PROJECTS</a>
        <text>/</text>
        <a href="talks">TALKS</a>
      </div>
    </div>
    <div class="separator">
      <div class="blog-header-button-container padded">
        <div class="blog-header-button">
             <a href="https://twitter.com/rockbruno_" target="_blank" style="display: flex;">
                <i class="fa fa-twitter"></i>
             </a>
        </div>
        <div class="blog-header-button">
             <a href="rss.xml" target="_blank">
                <i class="fa fa-rss"></i>
             </a>
        </div>
        <div class="blog-header-button">
             <a href="mailto:rockbruno@rockbruno.com" target="_blank">
                <i class="fa fa-envelope"></i>
             </a>
        </div>
        <div class="blog-header-button">
             <a href="https://github.com/rockbruno" target="_blank">
                <i class="fa fa-github"></i>
             </a>
        </div>
          <div class="blog-header-button">
           <a href="https://www.linkedin.com/in/bruno-rocha-45786a98/" target="_blank">
              <i class="fa fa-linkedin"></i>
           </a>
        </div>
      </div>
    </div>


<div class="content padded">
      <div id="WRITEIT_DYNAMIC_CONTENT">
<!--WRITEIT_POST_NAME=Reverse engineering a 5 year old Xcode issue-->
<!--WRITEIT_POST_HTML_NAME=reverse-engineering-xcode-issue-crash-symbol-->

<!--Add here the additional properties that you want each page to possess.-->
<!--These properties can be used to change content in the template page or in the page itself as shown here.-->
<!--Properties must start with 'WRITEIT_POST'.-->
<!--Writeit provides and injects WRITEIT_POST_NAME and WRITEIT_POST_HTML_NAME by default.-->

<!--WRITEIT_POST_SHORT_DESCRIPTION=Have you ever had issues with Xcode not symbolicating crashes? Me too, and I found the fix by reverse engineering the IDE.-->

<!--DateFormat example: 2021-08-31T14:00:00+02:00-->
<!--WRITEIT_POST_SITEMAP_DATE_LAST_MOD=2021-08-31T14:00:00+02:00-->
<!--WRITEIT_POST_SITEMAP_DATE=2021-08-31T14:00:00+02:00-->

<title>Reverse engineering a 5 year old Xcode issue</title>
<div class="blog-post">
  <div class="post-title-index">
    <h1>Reverse engineering a 5 year old Xcode issue</h1>
  </div>  
  <div class="post-info">
    <div class="category category-reverse">Reverse Engineering</div>
    <div class="post-info-text">Published on 31 Aug 2021</div>
  </div>
<p>Xcode has a feature called <b>Organizer</b> that shows you important information about builds you sent to the App Store, with the most relevant ones being crashes and energy reports (for CPU/memory usage). In my experience, this feature will work perfectly fine if you pushed the build from your <i>own</i> machine, but if that's not true for any reason (the most common being because you're using a CI pipeline to do) then you might have a frustrating experience. To be specific, if you didn't push the build from your machine, then all reports provided by Xcode will be unsymbolicated:</p>
<div class="post-image">
  <img src="https://i.imgur.com/9UaPOZb.png" alt="Alt">                                    
</div>
<p>This is perfectly expected given that the symbol information comes from the <b>dSYM</b> package that is generated when you archive your app, so it's also normal for CI pipelines to store the dSYMs of a build somewhere that can be retrieved later. The problem is that <b>even</b> if you have a copy of the original build archive, chances are that Xcode will not know what to do. If you right-click a stack trace and press <i>Symbolicate</i>, you'll either get a useless error or nothing will happen.</p>
<div class="sponsor-article-ad-auto hidden"></div>
<p>This bug is not deterministic (some people have it, some people don't), and it's not clear at first glance what factors make it work or not. What I do know is that a <b>lot</b> of people have experienced this -- a Google search will reveal many StackOverflow and Apple Developer threads complaining about this issue, <a href="https://developer.apple.com/forums/thread/51873">with the earliest being 5 years old.</a> The threads point to many CLI alternatives that can be used to symbolicate crashes manually, but no one seems to be able to pinpoint exactly <i>why</i> Xcode doesn't work in the first place. As you might also expect, Apple has never said or done anything about this.</p>
<p><i>"But wait a second Bruno, why do you care about this bug? Isn't everyone using Firebase for crash reporting?"</i></p>
<p>That is true, but the Organizer contains more than just plain crashes. I was particularly interested in reading Xcode's <b>energy reports</b> to learn more about cases where iOS decides to shut down apps due to high CPU usage, which are not reported to Firebase.</p>
<p>Additionally, even though there are many workarounds available to symbolicate crashes manually, <b>none of them work for the energy reports I wanted to look at.</b> The most common workaround shared by developers is to extract the <code>symbolicatecrash</code> file that exists inside Xcode and call it manually from the CLI, but this only works for regular crashes. To be specific, <code>symbolicatecrash</code> is in fact what Xcode uses to symbolicate energy reports, but because Xcode stores them in a different format, you're not able to pass them to <code>symbolicatecrash</code> without first somehow converting them, something of which I had no interest in doing as I had no idea what format this tool is looking for in the first place. To make it worse, because issues with CPU and memory usage tend to be rare in the iOS world, I couldn't find <i>any</i> workaround for this. I made an angry Twitter post, and sometime after that realized that if I want to see these logs then I should reverse engineer Xcode and fix this issue myself.</p>
<h2>Finding the source of the error</h2>
<p>The only piece of relevant information I had about this issue is the error that Xcode returns when attempting to symbolicate an energy report. Although the error is useless, it's customized enough to allow me to search for it inside the binary:</p>
<div class="post-image">
  <img src="https://i.imgur.com/NJJw17V.png" alt="Alt">                                    
</div>
<p>I then <code>grep</code>'d the entire Xcode archive for this string. It took a very long time for it to finish given that my Xcode is about 30 gigabytes in size, but it did find the reference inside the <code>IDEAnalyticsKit</code> framework:</p>
<pre>
Binary file .//PlugIns/IDEAnalyticsKit.framework/Versions/A/IDEAnalyticsKit matches
Binary file .//PlugIns/IDEAnalyticsKit.framework/Versions/Current/IDEAnalyticsKit matches
Binary file .//PlugIns/IDEAnalyticsKit.framework/IDEAnalyticsKit matches
</pre>
<p>Xcode is not one giant binary, but a collection of many smaller specialized frameworks. In fact, the main Xcode binary seems to do almost nothing but launch the other frameworks.</p>
<p>After opening the <code>IDEAnalyticsKit</code> binary in Hopper, I was easily able to locate the Obj-C method that hardcoded the error string:</p>
<div class="post-image">
  <img src="https://i.imgur.com/iBbWFVR.png" alt="Alt">                                    
</div>
<p>Thanks to Hopper's amazing feature of converting assembly to pseudocode, navigating the decompiled binary is a breeze. By selecting the first instruction of a method, I could navigate the stack trace all the way to the method that is called when the <i>Symbolicate</i> button is touched:</p>
<div class="post-image">
  <img src="https://i.imgur.com/dKfpaEs.png" alt="Alt">                                    
</div>
<p>In short, what this method does is simply assert that we're in the main thread and then start the symbolization process by sending a completion handler that throws the error we're ending up in. By navigating the assembly code with the help of Hopper's pseudocode feature, we should be able to find out exactly what's causing it to fail.</p>
<p>Following the symbolization trace eventually led me to <i>another</i> framework, <code>DVTAnalytics</code>, where a more specialized method lives:</p>
<div class="post-image">
  <img src="https://i.imgur.com/NqY13Jc.png" alt="Alt">                                    
</div>
<p>Despite being a long method, there's nothing special going on here -- Xcode is simply grabbing information about the crash and initializing more specialized objects as it travels from framework to framework. After setting up another completion handler, the journey continues inside <code>symbolicateWithCallback</code>.</p>
<p>When I tried navigating to that method, Hopper greeted me with this awesome pop-up:</p>
<div class="post-image">
  <img src="https://i.imgur.com/YvwFOgN.png" alt="Alt">                                    
</div>
<p>It turns out that Hopper is smart enough to notice that <code>symbolicateWithCallback</code> is a Obj-C protocol method that is implemented by three different objects in this framework, which represent the three different types of crashes available in the Organizer (crash, energy report and disk report)! After picking the energy variant, I eventually fell here:</p>
<div class="post-image">
  <img src="https://i.imgur.com/w4z5zFq.png" alt="Alt">                                    
</div>
<p>This method is saying that we're initializing a <code>DVTLocalLogSymbolicator</code> object and asking it to continue the process, but I couldn't find it anywhere in this framework. After another <code>grep</code>, I found out that this and all the core symbolization logic was placed in a separate <code>DVTFoundation</code> framework. After locating the class and its <code>symbolicateLogData</code> method, I was finally able to locate where the symbolization is done:</p>
<div class="post-image">
  <img src="https://i.imgur.com/Fuw2J77.png" alt="Alt">                                    
</div>
<p>This is essentially saying that Xcode is fetching and calling the <code>symbolicatecrash</code> utility, which is not a surprise given that this is exactly the workaround that we mentioned in the beginning. However, I could immediately tell what the problem was -- when this workaround is suggested, the correct way of invoking this utility is by sending the dSYM that contains the symbols you're trying to translate:</p>
<pre>
<code>symbolicatecrash --dsym ./symbols.dSYM --output ./symbolicated.txt</code>
</pre>
<p>However, Xcode doesn't do that -- it just sets the output and hopes for the best. What happens essentially is that this tool is capable of searching for dSYMs on its own, but for some reason sometimes it just fails to do so. I could easily reproduce the issue by trying to symbolicate a regular crash without passing the dsym argument:</p>
<pre>
<code>Did not find dsym for (uuid)</code>
</pre>
<p>My first assumption was that this tool was probably looking for specific names or in specific folders, and we could confirm that by opening <code>symbolicatecrash</code> in Hopper and reverse engineering that logic. But quickly I realized that there was something fishy going on, because what I found instead was... nothing?</p>
<div class="post-image">
  <img src="https://i.imgur.com/RAdUFL8.png" alt="Alt">                                    
</div>
<p>After being stumped for a while, my colleague Åke quickly noticed that although macOS says that this file is a binary, it's actually just a really big perl script!</p>
<pre>
<code>#!/usr/bin/perl -w</code>
<code>#</code>
<code># This script parses a crashdump file and attempts to resolve addresses into function names.</code>
<code>#</code>
<code># It finds symbol-rich binaries by:</code>
<code>#   a) searching in Spotlight to find .dSYM files by UUID, then finding the executable from there.</code>
<code>#       That finds the symbols for binaries that a developer has built with "DWARF with dSYM File".</code>
<code>#   b) searching in various SDK directories.</code>
<code>#</code>
<code># Copyright (c) 2008-2015 Apple Inc. All Rights Reserved.</code>
<code>#</code>
<code>#</code>
</pre>
<p>This made everything else easier, because we could now freely modify this script and test our changes without having to generate new binaries. The first thing we did was locate the part of the code that parsed the arguments, which was right in the beginning:</p>
<pre>
<code># read and parse command line</code>
<code>my $opt_help = 0;</code>
<code>my $opt_verbose = 0;</code>
<code>my $opt_output = "-";</code>
<code>my @opt_dsyms = ();</code>
<code>my $opt_spotlight = 1;</code>
</pre>
<p>If we know that <code>symbolicatecrash</code> works by sending the dSYM manually, could we simply override the <code>opt_dsyms</code> param and fix the issue? The answer is <b>yes!</b></p>
<div class="post-image">
  <img src="https://i.imgur.com/uSdkNsU.png" alt="Alt">                                    
</div>
<p>This was sufficient for the data gathering we wanted to do, but I was still interested in knowing why this script couldn't find the dSYMs on its own. After a deeper inspection, we can see that the script attempts to locate the dSYM in three ways:</p>
<ul>
<li>The --dsym flag</li>
<li>The /Volumes/Build/UUIDToSymbolMap folder</li>
<li>The <code>Symbols</code> folder inside of every iOS/macOS SDK you have installed</li>
</ul>
<p>If neither of those returned a valid result, <b>it attempts to search the symbols through Spotlight, your macOS's search engine.</b> More specifically, it runs the following command:</p>
<pre>
<code>mdfind \"com_apple_xcode_dsym_uuids == $canonical_uuid\"</code>
</pre>
<p>This means that the failure to symbolicate crashes isn't a problem with Xcode, but that for some reason Spotlight failed to add the dSYM to its search index. After some quick searches about Spotlight issues, I found two ways to force Spotlight to re-index a folder:</p>
<ul>
<li>The <code>mdimport</code> CLI tool, pointing directly to where the dSYM is stored.</li>
<li>This <a href="https://support.apple.com/en-us/HT201716">support article</a> from Apple</li>
</ul>
<div class="sponsor-article-ad-auto hidden"></div>
<p>I had mixed success with <code>mdimport</code> (in fact, I remember seeing this as a buried comment in one of the StackOverflow posts, so someone <i>did</i> also figure this out in the past), but the trick from the article solved it for me. I think this feature would've been better developed if Xcode allowed you to provide the dSYM manually instead of completely relying on Spotlight, but investigating this issue was a very fun couple of hours for me.</p>
</div>
</div>

<!-- Mailchimp -->
  <div id="mc_embed_signup" style="border-top: 1px solid #8152D8;">
  <div style="display:flex; justify-content: center; text-align: center;">
  <p style="padding-top: 8px; font-weight: 100; font-size: 16px;">Enjoyed this? Subscribe to be notified of new posts.</p>
  </div>
  <form action="https://rockbruno.us20.list-manage.com/subscribe/post?u=da5024a1e36d4236d45082a69&amp;id=9ed4678475" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" style="padding: 0;" novalidate>
      <div id="mc_embed_signup_scroll">
    
    <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="Your email address" required>
      <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_da5024a1e36d4236d45082a69_9ed4678475" tabindex="-1" value=""></div>
      <div class="clear"><input type="submit" value="Notify me of new posts" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
      </div>
  </form>
  </div>
<!-- Mailchimp End -->
    </div>

  </div>             

    <!-- All Javascript Plugins  -->
  <script type="text/javascript" src="js/jquery.min.js"></script> 
  <script type="text/javascript" src="js/prism3.js"></script> 
    <!-- Main Javascript File  -->
    <script type="text/javascript" src="js/scripts25.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RPRS5GLTLD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RPRS5GLTLD');
</script>

   </body>
 </html>
